<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>æ­´å²ãƒãƒˆãƒ«ï¼ãƒ‹ãƒƒãƒãƒ³å²ã‚¯ã‚¤ã‚º</title>
<link rel="manifest" href="./manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ãƒ‹ãƒƒãƒãƒ³å²">
<meta name="theme-color" content="#0a0a12">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Zen+Antique+Soft&family=Noto+Sans+JP:wght@400;700;900&display=swap');

  :root {
    --ink: #0a0a12;
    --paper: #f5f0e8;
    --red: #cc2200;
    --gold: #d4a017;
    --blue: #1a3a6b;
    --accent: #ff4422;
    --glow: #ffcc00;
    --green: #00c864;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--ink); min-height: 100vh;
    overflow-x: hidden; display: flex; align-items: center; justify-content: center;
  }
  .screen { display: none; width: 100%; max-width: 420px; min-height: 100vh; position: relative; }
  .screen.active { display: flex; flex-direction: column; }

  /* â•â•â• TITLE â•â•â• */
  #screen-title {
    background: linear-gradient(160deg,#0a0a12 0%,#1a0a05 60%,#0a0010 100%);
    align-items: center; justify-content: center; padding: 40px 24px; overflow: hidden;
  }
  .title-bg-lines {
    position: absolute; inset: 0; pointer-events: none;
    background: repeating-linear-gradient(0deg,transparent,transparent 48px,rgba(212,160,23,.06) 48px,rgba(212,160,23,.06) 49px),
      repeating-linear-gradient(90deg,transparent,transparent 48px,rgba(212,160,23,.04) 48px,rgba(212,160,23,.04) 49px);
  }
  .title-seal {
    width: 90px; height: 90px; border: 3px solid var(--gold); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; margin-bottom: 24px; position: relative;
    animation: rotateSeal 20s linear infinite;
    box-shadow: 0 0 30px rgba(212,160,23,.4),inset 0 0 20px rgba(212,160,23,.1);
  }
  .title-seal::before { content:''; position:absolute; inset:5px; border:1px solid rgba(212,160,23,.4); border-radius:50%; }
  .title-seal-kanji { font-family:'Zen Antique Soft',serif; font-size:36px; color:var(--gold); text-shadow:0 0 20px rgba(212,160,23,.8); }
  @keyframes rotateSeal { to { transform: rotate(360deg); } }
  .title-eyebrow { font-size:11px; letter-spacing:.4em; color:var(--gold); text-transform:uppercase; margin-bottom:12px; opacity:.8; }
  .title-main {
    font-family:'Zen Antique Soft',serif; font-size:42px; line-height:1.1; color:var(--paper); text-align:center;
    text-shadow:4px 4px 0 var(--red),0 0 40px rgba(204,34,0,.4); margin-bottom:8px;
    animation: titlePulse 3s ease-in-out infinite;
  }
  @keyframes titlePulse {
    0%,100% { text-shadow:4px 4px 0 var(--red),0 0 40px rgba(204,34,0,.3); }
    50% { text-shadow:4px 4px 0 var(--red),0 0 60px rgba(204,34,0,.6),0 0 100px rgba(255,68,34,.2); }
  }
  .title-sub { font-size:13px; color:rgba(245,240,232,.6); letter-spacing:.15em; margin-bottom:32px; text-align:center; }
  .title-chars { display:flex; justify-content:center; gap:0; margin-bottom:32px; position:relative; }
  .char-card { width:90px; height:130px; position:relative; cursor:default; }
  .char-card:nth-child(1) { transform:rotate(-8deg) translateX(10px); z-index:1; }
  .char-card:nth-child(2) { transform:translateY(-10px); z-index:3; }
  .char-card:nth-child(3) { transform:rotate(8deg) translateX(-10px); z-index:1; }
  .char-avatar {
    width:100%; height:100%; border-radius:8px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    font-family:'Zen Antique Soft',serif; border:2px solid; position:relative; overflow:hidden;
  }
  .char-card:nth-child(1) .char-avatar { background:linear-gradient(160deg,#1a0050,#0a002a); border-color:#7b2fff; }
  .char-card:nth-child(2) .char-avatar { background:linear-gradient(160deg,#4a0000,#200000); border-color:var(--red); box-shadow:0 0 20px rgba(204,34,0,.5); }
  .char-card:nth-child(3) .char-avatar { background:linear-gradient(160deg,#002a4a,#00101a); border-color:#00aaff; }
  .char-emoji { font-size:44px; line-height:1; margin-bottom:4px; }
  .char-name-tag { font-size:9px; color:rgba(255,255,255,.7); letter-spacing:.05em; text-align:center; padding:0 4px; }
  .char-era-badge { position:absolute; bottom:6px; left:0; right:0; text-align:center; font-size:8px; color:rgba(255,255,255,.5); }
  .speed-lines {
    position:absolute; inset:-20px; pointer-events:none;
    background:repeating-conic-gradient(rgba(255,255,255,.02) 0deg 5deg,transparent 5deg 10deg);
    border-radius:50%; animation:spinLines 8s linear infinite;
  }
  @keyframes spinLines { to { transform:rotate(360deg); } }
  .title-btns { display:flex; flex-direction:column; align-items:center; gap:10px; width:100%; }
  .start-btn {
    background:var(--red); color:white; border:none; border-radius:4px; padding:18px 48px;
    font-family:'Noto Sans JP',sans-serif; font-size:18px; font-weight:900; letter-spacing:.1em;
    cursor:pointer; position:relative; overflow:hidden;
    box-shadow:0 6px 0 #7a1100,0 8px 20px rgba(204,34,0,.4);
    transition:transform .1s,box-shadow .1s;
    clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%);
    width:100%; max-width:280px;
  }
  .start-btn:active { transform:translateY(4px); box-shadow:0 2px 0 #7a1100; }
  .start-btn::after {
    content:''; position:absolute; top:0; left:-100%; width:60%; height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);
    animation:btnShine 2.5s ease-in-out infinite;
  }
  @keyframes btnShine { to { left:200%; } }
  .sub-btn {
    background: var(--blue); color: white; border: none; border-radius: 4px;
    padding: 18px 48px; font-family: 'Noto Sans JP', sans-serif; font-size: 16px; font-weight: 900;
    letter-spacing: .1em; cursor: pointer; position: relative; overflow: hidden;
    box-shadow: 0 6px 0 #0d1f3a, 0 8px 20px rgba(26,58,107,.5);
    transition: transform .1s, box-shadow .1s;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
    width: 100%; max-width: 280px;
  }
  .sub-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #0d1f3a; }
  .sub-btn::after {
    content: ''; position: absolute; top: 0; left: -100%; width: 60%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.15), transparent);
    animation: btnShine 3s ease-in-out infinite;
  }
  .version-tag { position:absolute; bottom:56px; font-size:10px; color:rgba(245,240,232,.3); letter-spacing:.2em; }
  .admin-entry-btn {
    position:absolute; bottom:20px; right:20px; background:none;
    border:1px solid rgba(245,240,232,.12); color:rgba(245,240,232,.25); border-radius:4px;
    padding:5px 9px; font-size:10px; letter-spacing:.1em; font-family:"Noto Sans JP",sans-serif;
    cursor:pointer; transition:all .2s;
  }
  .admin-entry-btn:hover { border-color:rgba(245,240,232,.4); color:rgba(245,240,232,.6); }

  /* â•â•â• SHARED HEADER â•â•â• */
  .era-header {
    background:linear-gradient(180deg,#0a0a12,transparent);
    padding:24px 20px 16px; position:sticky; top:0; z-index:10; backdrop-filter:blur(10px);
  }
  .era-header-top { display:flex; align-items:center; gap:12px; margin-bottom:4px; }
  .back-btn {
    background:none; border:1px solid rgba(245,240,232,.2); color:rgba(245,240,232,.7);
    border-radius:4px; padding:6px 10px; cursor:pointer; font-size:12px; font-family:'Noto Sans JP',sans-serif;
  }
  .era-header h2 { font-family:'Zen Antique Soft',serif; font-size:20px; color:var(--paper); }
  .era-header p { font-size:11px; color:rgba(245,240,232,.4); letter-spacing:.1em; }

  /* â•â•â• ERA SELECT â•â•â• */
  #screen-era { background:#0d0d18; padding:0; overflow-y:auto; }
  .era-timeline { padding:16px 20px 40px; position:relative; }
  .era-timeline::before {
    content:''; position:absolute; left:36px; top:20px; bottom:40px;
    width:2px; background:linear-gradient(180deg,var(--gold),rgba(212,160,23,.1));
  }
  .era-item { display:flex; align-items:center; gap:16px; margin-bottom:12px; cursor:pointer; animation:fadeSlideIn .3s ease both; }
  .era-item:nth-child(1){animation-delay:.05s}.era-item:nth-child(2){animation-delay:.1s}
  .era-item:nth-child(3){animation-delay:.15s}.era-item:nth-child(4){animation-delay:.2s}
  .era-item:nth-child(5){animation-delay:.25s}.era-item:nth-child(6){animation-delay:.3s}
  .era-item:nth-child(7){animation-delay:.35s}.era-item:nth-child(8){animation-delay:.4s}
  @keyframes fadeSlideIn { from{opacity:0;transform:translateX(-20px)} to{opacity:1;transform:translateX(0)} }
  .era-dot {
    width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;
    font-size:16px; flex-shrink:0; position:relative; z-index:1; border:2px solid; transition:transform .2s;
  }
  .era-item:hover .era-dot { transform:scale(1.2); }
  .era-item:hover .era-card-inner { transform:translateX(4px); }
  .era-card-inner {
    flex:1; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:8px;
    padding:12px 16px; transition:background .2s,transform .2s,border-color .2s; position:relative; overflow:hidden;
  }
  .era-item:hover .era-card-inner { background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.2); }
  .era-item.cleared .era-card-inner { border-color:rgba(0,200,100,.3); }
  .era-card-name { font-family:'Zen Antique Soft',serif; font-size:16px; color:var(--paper); margin-bottom:2px; }
  .era-card-period { font-size:10px; color:rgba(245,240,232,.4); letter-spacing:.1em; }
  .era-card-meta { position:absolute; right:12px; top:50%; transform:translateY(-50%); text-align:right; }
  .era-card-count { font-size:10px; color:rgba(245,240,232,.3); }
  .era-card-bar { position:absolute; bottom:0; left:0; height:2px; border-radius:0 0 8px 8px; transition:width .4s; }

  /* â•â•â• DIFFICULTY â•â•â• */
  #screen-difficulty { background:#0d0d18; padding:0; overflow-y:auto; }
  .diff-grid { padding:20px; display:flex; flex-direction:column; gap:12px; }
  .diff-card {
    background:rgba(255,255,255,.04); border:1.5px solid rgba(255,255,255,.1); border-radius:10px;
    padding:20px; cursor:pointer; transition:background .2s,border-color .2s,transform .1s;
    display:flex; align-items:center; gap:16px;
  }
  .diff-card:active { transform:scale(.98); }
  .diff-card.easy { border-color:rgba(0,200,100,.3); }
  .diff-card.easy:hover { background:rgba(0,200,100,.08); border-color:rgba(0,200,100,.6); }
  .diff-card.normal { border-color:rgba(212,160,23,.3); }
  .diff-card.normal:hover { background:rgba(212,160,23,.08); border-color:rgba(212,160,23,.6); }
  .diff-card.hard { border-color:rgba(204,34,0,.3); }
  .diff-card.hard:hover { background:rgba(204,34,0,.08); border-color:rgba(204,34,0,.6); }
  .diff-card.all { border-color:rgba(0,170,255,.3); }
  .diff-card.all:hover { background:rgba(0,170,255,.08); border-color:rgba(0,170,255,.6); }
  .diff-icon { font-size:36px; flex-shrink:0; }
  .diff-label { font-family:'Zen Antique Soft',serif; font-size:18px; color:var(--paper); margin-bottom:4px; }
  .diff-desc { font-size:11px; color:rgba(245,240,232,.4); line-height:1.6; }

  /* â•â•â• QUIZ â•â•â• */
  #screen-quiz { background:#0d0d18; padding:0; }
  .quiz-topbar {
    padding:16px 20px 12px; display:flex; align-items:center; gap:12px;
    background:rgba(10,10,18,.8); backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,.06);
  }
  .quiz-era-label { font-size:11px; color:var(--gold); letter-spacing:.1em; font-weight:700; flex:1; }
  .quiz-score-display { font-family:'Zen Antique Soft',serif; font-size:18px; color:var(--paper); }
  .quiz-score-display span { color:var(--gold); font-size:22px; }
  .timer-bar-wrap { padding:0 20px; }
  .timer-bar-bg { height:6px; background:rgba(255,255,255,.08); border-radius:3px; overflow:hidden; margin-top:8px; }
  .timer-bar-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--gold),var(--accent)); transition:width 1s linear,background .3s; }
  .timer-text { font-size:11px; color:rgba(245,240,232,.4); text-align:right; margin-top:2px; }
  .quiz-char-area { padding:16px 20px 0; display:flex; align-items:flex-end; gap:16px; min-height:160px; }
  .quiz-char-figure { width:100px; flex-shrink:0; display:flex; flex-direction:column; align-items:center; }
  .quiz-char-emoji { font-size:72px; line-height:1; filter:drop-shadow(0 0 20px rgba(255,200,0,.3)); animation:charFloat 3s ease-in-out infinite; }
  @keyframes charFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
  .quiz-char-name { font-size:10px; color:rgba(245,240,232,.5); margin-top:4px; letter-spacing:.05em; }
  .speech-bubble {
    flex:1; background:rgba(245,240,232,.06); border:1px solid rgba(245,240,232,.12);
    border-radius:12px 12px 12px 4px; padding:14px 16px; position:relative;
  }
  .speech-bubble::before {
    content:''; position:absolute; left:-8px; bottom:20px;
    border:8px solid transparent; border-right-color:rgba(245,240,232,.12);
  }
  .q-number { font-size:10px; color:var(--gold); letter-spacing:.1em; font-weight:700; margin-bottom:8px; }
  .q-text { font-size:15px; line-height:1.7; color:var(--paper); font-weight:700; }
  .choices-area { padding:20px 20px 10px; display:flex; flex-direction:column; gap:10px; }
  .choice-btn {
    background:rgba(255,255,255,.05); border:1.5px solid rgba(255,255,255,.12); border-radius:8px;
    padding:14px 18px; color:var(--paper); font-family:'Noto Sans JP',sans-serif;
    font-size:14px; font-weight:700; text-align:left; cursor:pointer;
    display:flex; align-items:center; gap:12px;
    transition:background .15s,border-color .15s,transform .1s; position:relative; overflow:hidden;
  }
  .choice-btn:not(.disabled):hover { background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.25); transform:translateX(4px); }
  .choice-btn:not(.disabled):active { transform:scale(.98); }
  .choice-label {
    width:26px; height:26px; border-radius:50%; background:rgba(255,255,255,.1);
    display:flex; align-items:center; justify-content:center;
    font-size:12px; font-weight:900; flex-shrink:0; border:1px solid rgba(255,255,255,.2);
  }
  .choice-btn.correct { background:rgba(0,200,100,.15); border-color:var(--green); animation:correctPulse .4s ease; }
  .choice-btn.correct .choice-label { background:var(--green); border-color:var(--green); }
  @keyframes correctPulse { 0%{transform:scale(1)} 40%{transform:scale(1.03)} 100%{transform:scale(1)} }
  .choice-btn.wrong { background:rgba(204,34,0,.15); border-color:var(--red); animation:wrongShake .4s ease; }
  .choice-btn.wrong .choice-label { background:var(--red); border-color:var(--red); }
  @keyframes wrongShake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
  .choice-btn.disabled { cursor:default; }
  .hint-bubble { background:rgba(212,160,23,.1); border:1px solid rgba(212,160,23,.3); border-radius:8px; padding:10px 14px; margin:0 20px; display:none; }
  .hint-bubble.visible { display:block; }
  .hint-label { font-size:9px; color:var(--gold); letter-spacing:.2em; font-weight:700; margin-bottom:4px; }
  .hint-text { font-size:13px; color:rgba(245,240,232,.7); line-height:1.6; }
  .next-q-btn {
    display:none; margin:12px 20px 20px; padding:14px;
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
    color:var(--paper); font-family:'Noto Sans JP',sans-serif; font-size:15px; font-weight:700;
    border-radius:8px; cursor:pointer; text-align:center; letter-spacing:.05em; transition:background .2s;
  }
  .next-q-btn:hover { background:rgba(255,255,255,.15); }
  .combo-flash {
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    font-family:'Zen Antique Soft',serif; font-size:64px; font-weight:900;
    pointer-events:none; z-index:100; opacity:0; text-shadow:0 0 30px currentColor;
  }
  .combo-flash.show { animation:comboAnim .8s ease forwards; }
  @keyframes comboAnim {
    0%{opacity:0;transform:translate(-50%,-50%) scale(.3) rotate(-10deg)}
    30%{opacity:1;transform:translate(-50%,-50%) scale(1.2) rotate(3deg)}
    60%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(0)}
    100%{opacity:0;transform:translate(-50%,-50%) scale(1.1) rotate(0) translateY(-30px)}
  }

  /* â•â•â• RESULT â•â•â• */
  #screen-result {
    background:linear-gradient(160deg,#0a0a12 0%,#1a0a05 60%,#0a0010 100%);
    align-items:center; justify-content:flex-start; padding:40px 24px; text-align:center;
    position:relative; overflow:hidden; overflow-y:auto;
  }
  .result-burst {
    position:absolute; inset:0; pointer-events:none;
    background:repeating-conic-gradient(rgba(212,160,23,.03) 0deg 10deg,transparent 10deg 20deg);
    animation:spinLines 15s linear infinite;
  }
  .result-rank {
    font-family:'Zen Antique Soft',serif; font-size:80px; line-height:1; margin-bottom:8px; position:relative;
    animation:rankAppear .6s cubic-bezier(.175,.885,.32,1.275) both;
  }
  @keyframes rankAppear { from{opacity:0;transform:scale(0)} to{opacity:1;transform:scale(1)} }
  .result-title-label { font-size:12px; color:var(--gold); letter-spacing:.3em; margin-bottom:4px; }
  .result-title-text { font-family:'Zen Antique Soft',serif; font-size:28px; color:var(--paper); margin-bottom:24px; position:relative; }
  .result-score-box {
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
    border-radius:12px; padding:20px 40px; margin-bottom:20px; position:relative; width:100%;
  }
  .result-score-num { font-family:'Zen Antique Soft',serif; font-size:56px; color:var(--gold); text-shadow:0 0 30px rgba(212,160,23,.6); line-height:1; }
  .result-score-label { font-size:12px; color:rgba(245,240,232,.5); margin-top:4px; }
  .result-correct-count { font-size:14px; color:rgba(245,240,232,.6); margin-top:8px; }
  .result-gacha {
    background:rgba(212,160,23,.1); border:1px solid rgba(212,160,23,.4);
    border-radius:12px; padding:16px 20px; margin-bottom:20px; width:100%;
    display:none; text-align:left;
  }
  .result-gacha.visible { display:flex; gap:14px; align-items:center; }
  .gacha-emoji { font-size:56px; flex-shrink:0; animation:charReveal .5s cubic-bezier(.175,.885,.32,1.275); }
  @keyframes charReveal { from{transform:scale(0) rotate(-180deg);opacity:0} to{transform:scale(1) rotate(0);opacity:1} }
  .gacha-info { flex:1; }
  .gacha-header { display:flex; align-items:center; gap:6px; margin-bottom:4px; flex-wrap:wrap; }
  .gacha-rarity-badge { font-size:9px; font-weight:900; padding:2px 7px; border-radius:10px; }
  .gacha-rarity-badge.SR { background:linear-gradient(135deg,#ffd700,#ff8c00); color:white; }
  .gacha-rarity-badge.R { background:linear-gradient(135deg,#a0c4ff,#4080ff); color:white; }
  .gacha-rarity-badge.N { background:rgba(255,255,255,.15); color:rgba(245,240,232,.6); }
  .gacha-rarity-badge.SECRET { background:linear-gradient(135deg,#ffd700,#ff69b4,#ffd700); color:white; font-size:10px; }
  .gacha-new-badge { font-size:9px; background:var(--red); color:white; padding:2px 6px; border-radius:8px; }
  .gacha-unlock-label { font-size:10px; color:var(--gold); letter-spacing:.15em; margin-bottom:2px; }
  .gacha-name { font-family:'Zen Antique Soft',serif; font-size:18px; color:var(--paper); margin-bottom:4px; }
  .gacha-desc { font-size:11px; color:rgba(245,240,232,.5); line-height:1.5; }
  .gacha-skill { font-size:10px; color:var(--gold); margin-top:4px; font-style:italic; }
  .result-btns { display:flex; flex-direction:column; gap:12px; width:100%; position:relative; }
  .result-btn-primary {
    background:var(--red); color:white; border:none; border-radius:4px; padding:16px;
    font-family:'Noto Sans JP',sans-serif; font-size:16px; font-weight:900; cursor:pointer;
    box-shadow:0 4px 0 #7a1100; transition:transform .1s,box-shadow .1s;
    clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%);
  }
  .result-btn-primary:active { transform:translateY(3px); box-shadow:0 1px 0 #7a1100; }
  .result-btn-secondary {
    background:transparent; color:rgba(245,240,232,.6); border:1px solid rgba(245,240,232,.15);
    border-radius:4px; padding:14px; font-family:'Noto Sans JP',sans-serif; font-size:14px; font-weight:700;
    cursor:pointer; transition:border-color .2s,color .2s;
  }
  .result-btn-secondary:hover { border-color:rgba(245,240,232,.4); color:var(--paper); }

  /* â•â•â• ZUKAN â•â•â• */
  #screen-zukan { background:#0d0d18; padding:0; overflow-y:auto; }
  .zukan-body { padding:16px 20px 40px; }
  .zukan-secret-section {
    background:linear-gradient(135deg,rgba(212,160,23,.06),rgba(255,105,180,.04));
    border:1px solid rgba(212,160,23,.3); border-radius:12px; padding:16px; margin-bottom:24px;
  }
  .zukan-secret-title { font-family:'Zen Antique Soft',serif; font-size:15px; color:var(--gold); text-align:center; margin-bottom:14px; letter-spacing:.2em; }
  .zukan-secret-lock { text-align:center; padding:16px 0; }
  .zukan-secret-lock-icon { font-size:28px; margin-bottom:6px; }
  .zukan-secret-lock-text { font-size:12px; color:rgba(245,240,232,.3); }
  .zukan-secret-chars { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
  .secret-char-card {
    background:rgba(255,255,255,.04); border:1px solid rgba(212,160,23,.3);
    border-radius:8px; padding:14px 8px; text-align:center; cursor:pointer; transition:all .2s;
  }
  .secret-char-card.unlocked { border-color:var(--gold); background:rgba(212,160,23,.08); }
  .secret-char-card.locked-secret { opacity:.45; cursor:default; filter:grayscale(.5); }
  .secret-emoji { font-size:38px; margin-bottom:6px; }
  .secret-name { font-size:10px; color:var(--paper); font-weight:700; }
  .secret-hint { font-size:9px; color:rgba(245,240,232,.35); margin-top:3px; line-height:1.4; }
  .zukan-era-section { margin-bottom:24px; }
  .zukan-era-header { display:flex; align-items:center; gap:10px; border-bottom:1px solid rgba(212,160,23,.15); padding-bottom:8px; margin-bottom:12px; }
  .zukan-era-emoji { font-size:18px; }
  .zukan-era-name { font-family:'Zen Antique Soft',serif; font-size:14px; color:var(--paper); flex:1; }
  .zukan-era-count { font-size:10px; color:rgba(245,240,232,.35); }
  .zukan-chars-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; }
  .zukan-char-card {
    aspect-ratio:1; border-radius:8px; border:1.5px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.03); display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:4px; cursor:pointer; transition:all .2s; position:relative; font-size:26px;
  }
  .zukan-char-card.unlocked { border-color:rgba(255,255,255,.2); background:rgba(255,255,255,.06); }
  .zukan-char-card.unlocked.SR { border-color:var(--gold); background:rgba(212,160,23,.1); }
  .zukan-char-card.unlocked.R { border-color:#4080ff; background:rgba(64,128,255,.08); }
  .zukan-char-card.locked { filter:grayscale(1); opacity:.3; cursor:default; }
  .zukan-char-rarity { position:absolute; top:2px; right:3px; font-size:6px; font-weight:900; }
  .zukan-char-rarity.SR { color:var(--gold); }
  .zukan-char-rarity.R { color:#4080ff; }
  .zukan-char-label { font-size:7px; color:rgba(245,240,232,.4); text-align:center; margin-top:2px; line-height:1.2; }

  /* â•â•â• CHAR MODAL â•â•â• */
  .char-modal {
    position:fixed; inset:0; z-index:100; background:rgba(0,0,0,.8);
    display:flex; align-items:flex-end; justify-content:center;
    opacity:0; pointer-events:none; transition:opacity .25s;
  }
  .char-modal.active { opacity:1; pointer-events:all; }
  .char-modal-inner {
    background:linear-gradient(160deg,#12121e,#1a1410); border-radius:16px 16px 0 0;
    padding:24px 20px 40px; width:100%; max-width:420px; text-align:center;
    border-top:1px solid rgba(212,160,23,.3);
    transform:translateY(100%); transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  }
  .char-modal.active .char-modal-inner { transform:translateY(0); }
  .modal-emoji { font-size:80px; margin-bottom:12px; }
  .modal-rarity { display:inline-block; padding:3px 14px; border-radius:12px; font-size:11px; font-weight:900; margin-bottom:10px; }
  .modal-rarity.SR { background:linear-gradient(135deg,#ffd700,#ff8c00); color:white; }
  .modal-rarity.R { background:linear-gradient(135deg,#a0c4ff,#4080ff); color:white; }
  .modal-rarity.N { background:rgba(255,255,255,.1); color:rgba(245,240,232,.5); }
  .modal-rarity.SECRET { background:linear-gradient(135deg,#ffd700,#ff69b4); color:white; }
  .modal-name { font-family:'Zen Antique Soft',serif; font-size:22px; color:var(--paper); margin-bottom:10px; }
  .modal-desc { font-size:13px; color:rgba(245,240,232,.6); line-height:1.7; margin-bottom:12px; }
  .modal-skill { font-size:12px; color:var(--gold); font-style:italic; border-top:1px solid rgba(212,160,23,.2); padding-top:12px; }
  .modal-close { margin-top:20px; padding:12px 32px; background:rgba(255,255,255,.08); color:var(--paper); border:1px solid rgba(255,255,255,.15); border-radius:6px; font-family:'Noto Sans JP',sans-serif; font-size:14px; cursor:pointer; transition:background .2s; }
  .modal-close:hover { background:rgba(255,255,255,.15); }

  /* â•â•â• PASSWORD â•â•â• */
  #screen-password { background:linear-gradient(160deg,#0a0a12 0%,#0a0018 100%); align-items:center; justify-content:center; padding:40px 24px; text-align:center; }
  .pw-icon { font-size:48px; margin-bottom:16px; }
  .pw-title { font-family:"Zen Antique Soft",serif; font-size:22px; color:var(--paper); margin-bottom:6px; }
  .pw-sub { font-size:11px; color:rgba(245,240,232,.4); letter-spacing:.1em; margin-bottom:32px; }
  .pw-input-wrap { position:relative; width:100%; margin-bottom:10px; }
  .pw-input {
    width:100%; padding:16px 48px 16px 18px; background:rgba(255,255,255,.06);
    border:1.5px solid rgba(255,255,255,.15); border-radius:8px; color:var(--paper);
    font-family:"Noto Sans JP",sans-serif; font-size:16px; outline:none; transition:border-color .2s; letter-spacing:.15em;
  }
  .pw-input:focus { border-color:var(--gold); }
  .pw-input.error { border-color:var(--red); animation:wrongShake .4s ease; }
  .pw-toggle { position:absolute; right:14px; top:50%; transform:translateY(-50%); background:none; border:none; color:rgba(245,240,232,.4); cursor:pointer; font-size:18px; padding:4px; }
  .pw-submit-btn { width:100%; padding:16px; background:var(--blue); color:white; border:none; border-radius:8px; font-family:"Noto Sans JP",sans-serif; font-size:16px; font-weight:900; cursor:pointer; transition:background .2s; margin-bottom:16px; }
  .pw-submit-btn:hover { background:#1e4a8a; }
  .pw-error-msg { font-size:12px; color:var(--red); min-height:18px; margin-bottom:8px; }
  .pw-back-btn { background:none; border:none; color:rgba(245,240,232,.4); font-family:"Noto Sans JP",sans-serif; font-size:13px; cursor:pointer; text-decoration:underline; }

  /* â•â•â• ADMIN â•â•â• */
  #screen-admin { background:#0d0d18; overflow-y:auto; }
  .admin-header { background:rgba(10,10,18,.95); padding:20px 20px 14px; position:sticky; top:0; z-index:10; backdrop-filter:blur(10px); border-bottom:1px solid rgba(212,160,23,.2); }
  .admin-header-top { display:flex; align-items:center; gap:12px; margin-bottom:2px; }
  .admin-header h2 { font-family:"Zen Antique Soft",serif; font-size:18px; color:var(--gold); flex:1; }
  .admin-header-sub { font-size:10px; color:rgba(245,240,232,.35); letter-spacing:.1em; }
  .admin-stats { display:flex; gap:10px; padding:14px 20px 0; flex-wrap:wrap; }
  .admin-stat-card { flex:1; min-width:70px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:8px; padding:10px 12px; text-align:center; }
  .admin-stat-num { font-family:"Zen Antique Soft",serif; font-size:24px; color:var(--gold); }
  .admin-stat-label { font-size:9px; color:rgba(245,240,232,.4); margin-top:2px; }
  .admin-section { padding:20px 20px 0; }
  .admin-section-title { font-size:11px; color:var(--gold); letter-spacing:.2em; font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
  .admin-section-title::after { content:""; flex:1; height:1px; background:rgba(212,160,23,.2); }
  .form-group { display:flex; flex-direction:column; gap:4px; margin-bottom:10px; }
  .form-label { font-size:10px; color:rgba(245,240,232,.5); letter-spacing:.1em; font-weight:700; }
  .form-input { background:rgba(255,255,255,.06); border:1.5px solid rgba(255,255,255,.12); border-radius:6px; color:var(--paper); font-family:"Noto Sans JP",sans-serif; font-size:14px; padding:10px 12px; outline:none; transition:border-color .2s; }
  .form-input:focus { border-color:var(--gold); }
  .admin-log { background:rgba(0,0,0,.4); border:1px solid rgba(255,255,255,.08); border-radius:6px; padding:12px; font-family:monospace; font-size:12px; color:var(--green); max-height:160px; overflow-y:auto; line-height:1.6; white-space:pre-wrap; }
  .admin-btn { padding:10px 18px; border-radius:6px; border:none; font-family:'Noto Sans JP',sans-serif; font-size:12px; font-weight:700; cursor:pointer; transition:all .15s; margin-right:8px; margin-bottom:8px; }
  .admin-btn-green { background:#238636; color:white; }
  .admin-btn-gray { background:rgba(255,255,255,.08); color:rgba(245,240,232,.7); border:1px solid rgba(255,255,255,.12); }
  .admin-btn-red { background:var(--red); color:white; }

  /* â•â•â• PARTICLES / TOAST / LOADING â•â•â• */
  .particle { position:fixed; pointer-events:none; z-index:50; width:8px; height:8px; border-radius:50%; animation:particleFly 1s ease forwards; }
  @keyframes particleFly { to { transform:translate(var(--tx),var(--ty)) scale(0); opacity:0; } }
  .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--green); color:white; padding:12px 24px; border-radius:99px; font-family:"Noto Sans JP",sans-serif; font-size:14px; font-weight:700; z-index:200; transition:transform .3s ease; white-space:nowrap; box-shadow:0 4px 20px rgba(0,200,100,.4); }
  .toast.show { transform:translateX(-50%) translateY(0); }
  .toast.error-toast { background:var(--red); box-shadow:0 4px 20px rgba(204,34,0,.4); }
  .loading-overlay { position:fixed; inset:0; z-index:300; background:rgba(10,10,18,.9); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; opacity:0; pointer-events:none; transition:opacity .3s; }
  .loading-overlay.visible { opacity:1; pointer-events:all; }
  .loading-spinner { width:44px; height:44px; border:3px solid rgba(212,160,23,.2); border-top-color:var(--gold); border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .loading-text { font-size:13px; color:var(--gold); letter-spacing:.2em; }
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loadingText">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
</div>
<div class="toast" id="toast"></div>
<div class="combo-flash" id="comboFlash"></div>

<!-- â•â•â•â• TITLE â•â•â•â• -->
<div id="screen-title" class="screen active">
  <div class="title-bg-lines"></div>
  <div class="title-seal"><span class="title-seal-kanji">å²</span></div>
  <div class="title-eyebrow">NIHON-SHI QUIZ BATTLE</div>
  <div class="title-main">æ­´å²ãƒãƒˆãƒ«ï¼<br>ãƒ‹ãƒƒãƒãƒ³å²</div>
  <div class="title-sub">ç¸„æ–‡ã‹ã‚‰è¿‘ç¾ä»£ã¾ã§ å…¨æ™‚ä»£ã«æŒ‘ã‚</div>
  <div class="title-chars">
    <div class="speed-lines"></div>
    <div class="char-card"><div class="char-avatar"><div class="char-emoji">ğŸº</div><div class="char-name-tag">å‘å¼¥å‘¼</div><div class="char-era-badge">å¼¥ç”Ÿ</div></div></div>
    <div class="char-card"><div class="char-avatar"><div class="char-emoji">âš”ï¸</div><div class="char-name-tag">ç¹”ç”°ä¿¡é•·</div><div class="char-era-badge">æˆ¦å›½</div></div></div>
    <div class="char-card"><div class="char-avatar"><div class="char-emoji">ğŸŒŠ</div><div class="char-name-tag">å‚æœ¬é¾é¦¬</div><div class="char-era-badge">å¹•æœ«</div></div></div>
  </div>
  <div class="title-btns">
    <button class="start-btn" onclick="showEraSelect()">ã¯ã€€ã˜ã€€ã‚ã€€ã‚‹</button>
    <button class="sub-btn" onclick="showZukan()">ğŸ“– ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›³é‘‘</button>
  </div>
  <div class="version-tag">å±±å·æº–æ‹  120å• NOTIONé€£æº</div>
  <button class="admin-entry-btn" onclick="showPassword()">âš™ ç®¡ç†</button>
</div>

<!-- â•â•â•â• ERA SELECT â•â•â•â• -->
<div id="screen-era" class="screen">
  <div class="era-header">
    <div class="era-header-top">
      <button class="back-btn" onclick="showTitle()">â† ã‚‚ã©ã‚‹</button>
      <h2>â›© æ™‚ä»£ã‚’é¸ã¹</h2>
    </div>
    <p id="eraProgress">CHOOSE YOUR ERA â€” å…¨8æ™‚ä»£</p>
  </div>
  <div class="era-timeline" id="eraTimeline"></div>
</div>

<!-- â•â•â•â• DIFFICULTY â•â•â•â• -->
<div id="screen-difficulty" class="screen">
  <div class="era-header">
    <div class="era-header-top">
      <button class="back-btn" onclick="showEraSelect()">â† ã‚‚ã©ã‚‹</button>
      <h2 id="diffEraTitle">é›£æ˜“åº¦ã‚’é¸ã¹</h2>
    </div>
    <p>CHOOSE DIFFICULTY</p>
  </div>
  <div class="diff-grid">
    <div class="diff-card easy" onclick="startQuiz('easy')">
      <div class="diff-icon">ğŸŒ±</div>
      <div>
        <div style="color:var(--green);font-size:13px;margin-bottom:2px">â˜…â˜†â˜†</div>
        <div class="diff-label" style="color:var(--green)">ã‚„ã•ã—ã„</div>
        <div class="diff-desc">åŸºæœ¬çš„ãªç”¨èªãƒ»äººç‰©ãƒ»å‡ºæ¥äº‹<br>5å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
      </div>
    </div>
    <div class="diff-card normal" onclick="startQuiz('normal')">
      <div class="diff-icon">âš”ï¸</div>
      <div>
        <div style="color:var(--gold);font-size:13px;margin-bottom:2px">â˜…â˜…â˜†</div>
        <div class="diff-label" style="color:var(--gold)">ãµã¤ã†</div>
        <div class="diff-desc">æ™‚ä»£ã®æµã‚Œã¨èƒŒæ™¯ã‚’ç†è§£<br>5å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
      </div>
    </div>
    <div class="diff-card hard" onclick="startQuiz('hard')">
      <div class="diff-icon">ğŸ”¥</div>
      <div>
        <div style="color:var(--red);font-size:13px;margin-bottom:2px">â˜…â˜…â˜…</div>
        <div class="diff-label" style="color:var(--red)">ã‚€ãšã‹ã—ã„</div>
        <div class="diff-desc">å±±å·æ•™ç§‘æ›¸ãƒ¬ãƒ™ãƒ«ã®é›£å•<br>5å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
      </div>
    </div>
    <div class="diff-card all" onclick="startQuiz('all')">
      <div class="diff-icon">ğŸ²</div>
      <div>
        <div class="diff-label" style="color:#00aaff">ãƒ©ãƒ³ãƒ€ãƒ å…¨é›£æ˜“åº¦</div>
        <div class="diff-desc">å…¨15å•ã¾ã¨ã‚ã¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸<br>å…¨å•æ­£è§£ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒ£ãƒ³ã‚¹ï¼</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â• QUIZ â•â•â•â• -->
<div id="screen-quiz" class="screen">
  <div class="quiz-topbar">
    <div class="quiz-era-label" id="quizEraLabel"></div>
    <div class="quiz-score-display">Score <span id="scoreDisplay">0</span></div>
  </div>
  <div class="timer-bar-wrap">
    <div class="timer-bar-bg"><div class="timer-bar-fill" id="timerBar" style="width:100%"></div></div>
    <div class="timer-text" id="timerText">20ç§’</div>
  </div>
  <div class="quiz-char-area">
    <div class="quiz-char-figure">
      <div class="quiz-char-emoji" id="quizCharEmoji">âš”ï¸</div>
      <div class="quiz-char-name" id="quizCharName"></div>
    </div>
    <div class="speech-bubble">
      <div class="q-number" id="qNumber">å•1 / 5</div>
      <div class="q-text" id="qText"></div>
    </div>
  </div>
  <div class="choices-area" id="choicesArea"></div>
  <div class="hint-bubble" id="hintBubble"><div class="hint-label">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</div><div class="hint-text" id="hintText"></div></div>
  <button class="next-q-btn" id="nextQBtn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸ â†’</button>
</div>

<!-- â•â•â•â• RESULT â•â•â•â• -->
<div id="screen-result" class="screen">
  <div class="result-burst"></div>
  <div class="result-rank" id="resultRank">â­</div>
  <div class="result-title-label">ç§°ã€€å·</div>
  <div class="result-title-text" id="resultTitle"></div>
  <div class="result-score-box">
    <div class="result-score-num" id="resultScore">0</div>
    <div class="result-score-label">SCORE</div>
    <div class="result-correct-count" id="resultCorrect"></div>
  </div>
  <div class="result-gacha" id="resultGacha">
    <div class="gacha-emoji" id="gachaEmoji"></div>
    <div class="gacha-info">
      <div class="gacha-unlock-label">ğŸ”“ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç²å¾—ï¼</div>
      <div class="gacha-header">
        <div class="gacha-rarity-badge" id="gachaRarity"></div>
        <div class="gacha-new-badge" id="gachaNewBadge" style="display:none">NEW!</div>
      </div>
      <div class="gacha-name" id="gachaName"></div>
      <div class="gacha-desc" id="gachaDesc"></div>
      <div class="gacha-skill" id="gachaSkill"></div>
    </div>
  </div>
  <div class="result-btns">
    <button class="result-btn-primary" onclick="replayQuiz()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼</button>
    <button class="result-btn-secondary" onclick="showDiffSelect()">é›£æ˜“åº¦ã‚’å¤‰ãˆã‚‹</button>
    <button class="result-btn-secondary" onclick="showEraSelect()">æ™‚ä»£é¸æŠã¸ã‚‚ã©ã‚‹</button>
    <button class="result-btn-secondary" onclick="showZukan()">ğŸ“– å›³é‘‘ã‚’è¦‹ã‚‹</button>
    <button class="result-btn-secondary" onclick="showTitle()">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
  </div>
</div>

<!-- â•â•â•â• ZUKAN â•â•â•â• -->
<div id="screen-zukan" class="screen">
  <div class="era-header">
    <div class="era-header-top">
      <button class="back-btn" onclick="showTitle()">â† ã‚‚ã©ã‚‹</button>
      <h2>ğŸ“– ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›³é‘‘</h2>
    </div>
    <p id="zukanProgress"></p>
  </div>
  <div class="zukan-body" id="zukanBody"></div>
</div>

<!-- â•â•â•â• PASSWORD â•â•â•â• -->
<div id="screen-password" class="screen">
  <div class="pw-icon">ğŸ”</div>
  <div class="pw-title">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
  <div class="pw-sub">ADMIN ACCESS â€” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
  <div class="pw-input-wrap">
    <input class="pw-input" id="pwInput" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" onkeydown="if(event.key==='Enter')checkPassword()">
    <button class="pw-toggle" onclick="togglePwVisibility()" id="pwToggle">ğŸ‘</button>
  </div>
  <div class="pw-error-msg" id="pwError"></div>
  <button class="pw-submit-btn" onclick="checkPassword()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button class="pw-back-btn" onclick="showTitle()">â† ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚‚ã©ã‚‹</button>
</div>

<!-- â•â•â•â• ADMIN â•â•â•â• -->
<div id="screen-admin" class="screen">
  <div class="admin-header">
    <div class="admin-header-top">
      <button class="back-btn" onclick="showTitle()">â† ã‚‚ã©ã‚‹</button>
      <h2>âš™ ç®¡ç†ç”»é¢</h2>
    </div>
    <div class="admin-header-sub">ADMIN â€” NOTIONé€£æº & ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
  </div>
  <div class="admin-stats" id="adminStats"></div>
  <div class="admin-section" style="margin-top:20px">
    <div class="admin-section-title">ğŸ”— Notion APIé€£æº</div>
    <div class="form-group">
      <label class="form-label">Notion API Key (secret_xxx...)</label>
      <input type="text" class="form-input" id="notionApiInput" placeholder="secret_xxxxxxxx...">
    </div>
    <button class="admin-btn admin-btn-green" onclick="saveNotionKey()">APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
    <button class="admin-btn admin-btn-gray" onclick="syncFromNotion()">æ‰‹å‹•åŒæœŸ â†»</button>
    <div class="admin-log" id="adminLog">ç®¡ç†ãƒ­ã‚°å¾…æ©Ÿä¸­...\n</div>
  </div>
  <div class="admin-section" style="margin-top:20px;padding-bottom:40px">
    <div class="admin-section-title">âš  ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</div>
    <button class="admin-btn admin-btn-red" onclick="confirmReset('progress')">é€²è¡ŒçŠ¶æ³ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="admin-btn admin-btn-red" onclick="confirmReset('chars')">ã‚­ãƒ£ãƒ©ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="admin-btn admin-btn-red" onclick="confirmReset('all')">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<!-- CHAR MODAL -->
<div class="char-modal" id="charModal" onclick="closeCharModal()">
  <div class="char-modal-inner" onclick="event.stopPropagation()">
    <div class="modal-emoji" id="modalEmoji"></div>
    <div class="modal-rarity" id="modalRarity"></div>
    <div class="modal-name" id="modalName"></div>
    <div class="modal-desc" id="modalDesc"></div>
    <div class="modal-skill" id="modalSkill"></div>
    <button class="modal-close" onclick="closeCharModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
const ADMIN_PASSWORD = 'poopoo0730';
const NOTION_DB_ID   = '518d967babdf4bddb687264b1999d75b';
const LS = { PROGRESS:'nihonshi_progress_v2', UNLOCKED:'nihonshi_unlocked_v2', NOTION_KEY:'nihonshi_notion_key', NOTION_CACHE:'nihonshi_notion_cache' };
const DIFF_LABELS = { easy:'â˜… ã‚„ã•ã—ã„', normal:'â˜…â˜… ãµã¤ã†', hard:'â˜…â˜…â˜… ã‚€ãšã‹ã—ã„' };

const ERAS = [
  { id:'jomon',    name:'ç¸„æ–‡ãƒ»å¼¥ç”Ÿ',     period:'ã€œ3ä¸–ç´€',       emoji:'ğŸº', color:'#8B6914', glow:'rgba(139,105,20,0.4)', notionName:'ç¸„æ–‡ãƒ»å¼¥ç”Ÿ',     char:'å‘å¼¥å‘¼',     charEmoji:'ğŸº' },
  { id:'kofun',    name:'å¤å¢³ãƒ»é£›é³¥',     period:'3ã€œ8ä¸–ç´€',      emoji:'ğŸ—¿', color:'#5a4f9a', glow:'rgba(90,79,154,0.4)',  notionName:'å¤å¢³ãƒ»é£›é³¥',     char:'è–å¾³å¤ªå­',   charEmoji:'ğŸ“œ' },
  { id:'nara',     name:'å¥ˆè‰¯ãƒ»å¹³å®‰',     period:'710ã€œ1185å¹´',   emoji:'ğŸ¦Œ', color:'#3a7a3a', glow:'rgba(58,122,58,0.4)',  notionName:'å¥ˆè‰¯ãƒ»å¹³å®‰',     char:'è—¤åŸé“é•·',   charEmoji:'ğŸŒ•' },
  { id:'kamakura', name:'éŒå€‰ãƒ»å®¤ç”º',     period:'1185ã€œ1573å¹´',  emoji:'â›©', color:'#7a2020', glow:'rgba(122,32,32,0.5)',  notionName:'éŒå€‰ãƒ»å®¤ç”º',     char:'æºé ¼æœ',     charEmoji:'ğŸ¯' },
  { id:'sengoku',  name:'æˆ¦å›½ãƒ»å®‰åœŸæ¡ƒå±±', period:'1467ã€œ1615å¹´',  emoji:'âš”ï¸', color:'#cc2200', glow:'rgba(204,34,0,0.5)',   notionName:'æˆ¦å›½ãƒ»å®‰åœŸæ¡ƒå±±', char:'ç¹”ç”°ä¿¡é•·',   charEmoji:'âš”ï¸' },
  { id:'edo',      name:'æ±Ÿæˆ¸',           period:'1603ã€œ1868å¹´',  emoji:'ğŸ—»', color:'#1a5a8a', glow:'rgba(26,90,138,0.5)',  notionName:'æ±Ÿæˆ¸',           char:'å¾³å·å®¶åº·',   charEmoji:'ğŸ—»' },
  { id:'meiji',    name:'æ˜æ²»ãƒ»å¤§æ­£',     period:'1868ã€œ1926å¹´',  emoji:'ğŸŒ…', color:'#9a4a00', glow:'rgba(154,74,0,0.5)',   notionName:'æ˜æ²»ãƒ»å¤§æ­£',     char:'å‚æœ¬é¾é¦¬',   charEmoji:'ğŸŒŠ' },
  { id:'showa',    name:'æ˜­å’Œãƒ»è¿‘ç¾ä»£',   period:'1926å¹´ã€œç¾ä»£',  emoji:'ğŸ•Šï¸', color:'#3a6a3a', glow:'rgba(58,106,58,0.5)',  notionName:'æ˜­å’Œãƒ»è¿‘ç¾ä»£',   char:'æ±éƒ·å¹³å…«éƒ', charEmoji:'ğŸ•Šï¸' },
];

const ALL_CHARS = [
  { id:'jomon_1',    eraId:'jomon',    rarity:'SR', emoji:'ğŸº', name:'ç¸„æ–‡ã®ã¾ã˜ãªã„å¸«',   desc:'æ·±ã„æ£®ã®ä¸­ã§åœŸå¶ã‚’ä½œã‚Šç¶šã‘ãŸå¤ã®å‘ªè¡“å¸«ã€‚è‡ªç„¶ã®éœŠåŠ›ã‚’æ“ã‚Šã€é›†è½ã‚’å®ˆè­·ã™ã‚‹ã€‚', skill:'åœŸå¶å¬å–š â€” å¤±ç‚¹ã‚’1å•å¸³æ¶ˆã—ã«ã™ã‚‹ç¥ç§˜ã®åŠ›ï¼' },
  { id:'jomon_2',    eraId:'jomon',    rarity:'R',  emoji:'ğŸš', name:'è²å¡šã®è¨˜æ†¶ç•ª',       desc:'è²å¡šã«æ®‹ã•ã‚ŒãŸè¨˜éŒ²ã‚’å®ˆã‚Šç¶šã‘ã‚‹èªã‚Šéƒ¨ã€‚é£Ÿæ–‡åŒ–ã®æ­´å²ã‚’çŸ¥ã‚Šå°½ãã—ã¦ã„ã‚‹ã€‚', skill:'è²è¨˜éŒ² â€” æ­£è§£æ™‚ã®ãƒã‚¤ãƒ³ãƒˆãŒ2å€ã«ãªã‚‹ï¼' },
  { id:'jomon_3',    eraId:'jomon',    rarity:'N',  emoji:'ğŸŒ¾', name:'å¼¥ç”Ÿã®ç¨²ä½œå°‘å¥³',     desc:'ç”°ã‚“ã¼ã§æ±—ã‚’æµã™å‹¤å‹‰ãªè¾²æ‘ã®å¨˜ã€‚ç¨²ä½œã®çŸ¥æµã¨æ°´è·¯ã®èª­ã¿æ–¹ã‚’çˆ¶ã‹ã‚‰ç¿’ã£ãŸã€‚', skill:'è±Šç©£ã®èˆ â€” ãƒ’ãƒ³ãƒˆã‚’1å›ç„¡æ–™ã§ä½¿ãˆã‚‹ï¼' },
  { id:'jomon_4',    eraId:'jomon',    rarity:'N',  emoji:'ğŸ—ï¸', name:'é‚ªé¦¬å°å›½ã®ä½¿è€…',     desc:'å‘å¼¥å‘¼ã«ä»•ãˆã€é­ã®éƒ½ã¸è²¢ãç‰©ã‚’å±Šã‘ãŸå¤–äº¤å®˜ã€‚é ã„æµ·ã‚’æ¸¡ã£ãŸå‹‡æ°—ã®æŒã¡ä¸»ã€‚', skill:'å¤–äº¤è¡“ â€” èª¤ç­”ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›ã™ã‚‹ï¼' },
  { id:'jomon_5',    eraId:'jomon',    rarity:'N',  emoji:'ğŸ””', name:'éŠ…é¸ã®è·äºº',         desc:'ç²¾ç·»ãªéŠ…é¸ã‚’é‹³é€ ã—ç¶šã‘ãŸå¼¥ç”Ÿã®åå·¥ã€‚ãã®éŸ³è‰²ã¯æ‘ã®å¹³å’Œã‚’å‘¼ã¶ã¨ã„ã‚ã‚ŒãŸã€‚', skill:'ç¥­éŸ³ â€” å•é¡Œé–‹å§‹æ™‚ã«å…¨å“¡ã®å£«æ°—ã‚’é«˜ã‚ã‚‹ï¼' },
  { id:'kofun_1',    eraId:'kofun',    rarity:'SR', emoji:'ğŸ‘‘', name:'è–å¾³å¤ªå­ã®éœŠå…‰',     desc:'åä¸ƒæ¡ã®æ†²æ³•ã‚’åˆ¶å®šã—ã€ä»æ•™ã‚’åºƒã‚ãŸå‰å¤§ãªæ‘‚æ”¿ã€‚ä¸€åº¦ã«åäººã®å£°ã‚’èã„ãŸã¨ã„ã†ä¼èª¬ã‚‚ã€‚', skill:'åäººã®å£° â€” æ¬¡ã®å•é¡Œã®é¸æŠè‚¢ã‚’2æŠã«çµã‚Œã‚‹ï¼' },
  { id:'kofun_2',    eraId:'kofun',    rarity:'R',  emoji:'ğŸ•Šï¸', name:'é£éš‹ä½¿ã®æ—…äºº',       desc:'å±é™ºãªæµ·ã‚’è¶Šãˆã¦éš‹ã«æ¸¡ã£ãŸå¤–äº¤ä½¿ç¯€ã€‚æ–‡åŒ–ã¨çŸ¥è­˜ã‚’æ—¥æœ¬ã«æŒã¡å¸°ã‚‹ãŸã‚ã«å‘½ãŒã‘ã ã£ãŸã€‚', skill:'æµ·è·¯ã®çŸ¥æµ â€” ãƒ’ãƒ³ãƒˆã®ç²¾åº¦ãŒä¸ŠãŒã‚‹ï¼' },
  { id:'kofun_3',    eraId:'kofun',    rarity:'N',  emoji:'ğŸª–', name:'å¤§åŒ–ã®æ”¹æ–°å…µå£«',     desc:'ä¸­å¤§å…„çš‡å­ã¨ã¨ã‚‚ã«è˜‡æˆ‘æ°ã‚’å€’ã—ãŸæ”¹é©ã®ä¸€å“¡ã€‚å¾‹ä»¤å›½å®¶ã¸ã®å¤§è»¢æ›ã‚’æ”¯ãˆãŸç„¡åã®è‹±é›„ã€‚', skill:'æ”¹é©ã®å‰£ â€” æ­£è§£é€£ç¶š3å•ã§ãƒœãƒ¼ãƒŠã‚¹ï¼' },
  { id:'kofun_4',    eraId:'kofun',    rarity:'N',  emoji:'ğŸ›•', name:'æ³•éš†å¯ºã®å¤§å·¥',       desc:'ä¸–ç•Œæœ€å¤ã®æœ¨é€ å»ºç¯‰ã‚’æ‰‹ãŒã‘ãŸé£›é³¥ã®ååŒ ã€‚1400å¹´ä»¥ä¸ŠçµŒã£ãŸä»Šã‚‚å»ºç‰©ã¯ç¾å­˜ã—ã¦ã„ã‚‹ã€‚', skill:'åŒ ã®æŠ€ â€” å»ºç¯‰çŸ¥è­˜ã§åŠ ç‚¹ãƒœãƒ¼ãƒŠã‚¹ï¼' },
  { id:'kofun_5',    eraId:'kofun',    rarity:'N',  emoji:'ğŸ', name:'ã¯ã«ã‚ã®é¦¬',         desc:'å¤å¢³ã«åŸ‹è‘¬ã•ã‚ŒãŸç´ ç„¼ãã®é¦¬å½¢åŸ´è¼ªã€‚æ­»è€…ã®é­‚ã¨ã¨ã‚‚ã«æ¬¡ã®ä¸–ç•Œã¸æ—…ã™ã‚‹å®ˆè­·ã®ä½¿è€…ã€‚', skill:'é­‚ã®ç–¾èµ° â€” ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹2å€ï¼' },
  { id:'nara_1',     eraId:'nara',     rarity:'SR', emoji:'ğŸ¦Œ', name:'å¥ˆè‰¯ã®å¤§ä»å®ˆ',       desc:'æ±å¤§å¯ºã®å¤§ä»ã‚’æ¯æ—¥æ¸…ã‚ç¶šã‘ã‚‹åƒ§ä¾¶ã€‚ä»ã®åŠ è­·ã§å¤©ä¸‹æ³°å¹³ã‚’é¡˜ã„ç¶šã‘ãŸç”Ÿæ¶¯ã€‚', skill:'ä»é™€ã®åŠ è­· â€” ä¸æ­£è§£ã‚’æ­£è§£ã«å¤‰ãˆã‚‹å¥‡è·¡ï¼' },
  { id:'nara_2',     eraId:'nara',     rarity:'R',  emoji:'ğŸ“œ', name:'ç´«å¼éƒ¨ã®ä¾å¥³',       desc:'æºæ°ç‰©èªã®åŸ·ç­†ã‚’æ‰‹ä¼ã£ãŸæ‰å¥³ã€‚ç¾ã—ã„ä»®åæ–‡å­—ã§ç‰©èªã‚’æ›¸ãå†™ã—ç¶šã‘ãŸã€‚', skill:'ã‹ãªæ›¸æ³• â€” ãƒ†ã‚­ã‚¹ãƒˆç³»å•é¡Œã«å¼·åŒ–ãƒœãƒ¼ãƒŠã‚¹ï¼' },
  { id:'nara_3',     eraId:'nara',     rarity:'N',  emoji:'â›µ', name:'é‘‘çœŸã®æ¸¡æ¥å¼Ÿå­',     desc:'ç›²ç›®ã«ãªã‚ŠãªãŒã‚‰ã‚‚æ—¥æœ¬ã¸æ¸¡ã‚Šä»æ³•ã‚’ä¼ãˆãŸé‘‘çœŸå’Œä¸Šã®é«˜å¼Ÿã€‚ä¸å±ˆã®ç²¾ç¥ã‚’ç¶™æ‰¿ã™ã‚‹ã€‚', skill:'ä¸å±ˆã®ä¿¡å¿µ â€” æœ€å¾Œã®å•é¡Œã§é€†è»¢ã§ãã‚‹ï¼' },
  { id:'nara_4',     eraId:'nara',     rarity:'N',  emoji:'ğŸŒº', name:'å¹³å®‰ã®æ­Œè© ã¿äºº',     desc:'ç™¾äººä¸€é¦–ã«é¸ã°ã‚ŒãŸæ­Œäººã€‚æ‹ã¨è‡ªç„¶ã‚’è© ã‚“ã å’Œæ­Œã¯åƒå¹´å¾Œã‚‚äººã€…ã®å¿ƒã‚’æ‰“ã¤ã€‚', skill:'æ­Œã®åŠ› â€” ãƒ’ãƒ³ãƒˆãŒè©©çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼' },
  { id:'nara_5',     eraId:'nara',     rarity:'N',  emoji:'ğŸµ', name:'ç©ºæµ·ã®è–¬å¸«',         desc:'é«˜é‡å±±ã«ç± ã‚Šç§˜è–¬ã‚’èª¿åˆã—ç¶šã‘ãŸçœŸè¨€å®—ã®åƒ§åŒ»ã€‚å¯†æ•™ã®ç¥ç§˜ã¨åŒ»è¡“ã‚’å…¼ã­å‚™ãˆã‚‹ã€‚', skill:'ç§˜è–¬èª¿åˆ â€” æ®‹ã‚Šæ™‚é–“ãŒå»¶é•·ã•ã‚Œã‚‹ï¼' },
  { id:'kamakura_1', eraId:'kamakura', rarity:'SR', emoji:'ğŸ¹', name:'æºç¾©çµŒã®å½±æ­¦è€…',     desc:'å£‡ãƒæµ¦ã§å¹³å®¶ã‚’æ»…ã¼ã—ãŸä¼èª¬ã®æ­¦å°†ã®å½±ã€‚å¥‡ç­–ã®å¤©æ‰ã¨ã—ã¦ä»Šã‚‚èªã‚Šç¶™ãŒã‚Œã‚‹ã€‚', skill:'å¥‡ç­– â€” ãƒ©ãƒ³ãƒ€ãƒ ã«é›£å•ã‚’ã‚„ã•ã—ã„å•é¡Œã«å¤‰ãˆã‚‹ï¼' },
  { id:'kamakura_2', eraId:'kamakura', rarity:'R',  emoji:'â›ˆï¸', name:'å…ƒå¯‡ã®ç¥é¢¨',         desc:'äºŒåº¦ã«ã‚ãŸã‚‹å…ƒã®å¤§è»ã‚’å¹ãé£›ã°ã—ãŸç¥ç§˜ã®é¢¨ã€‚æ—¥æœ¬ã‚’å®ˆè­·ã™ã‚‹è‡ªç„¶ã®åŠ›ã®åŒ–èº«ã€‚', skill:'ç¥é¢¨åŠ è­· â€” 1å•ã ã‘èª¤ç­”ã‚’å¸³æ¶ˆã—ã«ã™ã‚‹ï¼' },
  { id:'kamakura_3', eraId:'kamakura', rarity:'N',  emoji:'ğŸŒ¿', name:'è¦ªé¸ã®æ—…åƒ§',         desc:'æ‚ªäººæ­£æ©Ÿèª¬ã‚’èª¬ããªãŒã‚‰å„åœ°ã‚’æ”¾æµªã—ãŸæµ„åœŸçœŸå®—ã®ç¥–ã®å¼Ÿå­ã€‚æ°‘è¡†ã«ä»ã®æ…ˆæ‚²ã‚’ä¼ãˆãŸã€‚', skill:'æ‚ªäººæ­£æ©Ÿ â€” èª¤ç­”ã—ã¦ã‚‚ãƒã‚¤ãƒ³ãƒˆãŒå…¥ã‚‹ç‰¹æ®ŠæŠ€ï¼' },
  { id:'kamakura_4', eraId:'kamakura', rarity:'N',  emoji:'ğŸ¯', name:'è¶³åˆ©ç¾©æº€ã®èƒ½å½¹è€…',   desc:'é‡‘é–£å¯ºã®åº­ã§èƒ½ã‚’æ¼”ã˜ãŸå®¤ç”ºæ™‚ä»£ã®èŠ¸è¡“å®¶ã€‚ä¸–é˜¿å¼¥ã®æ•™ãˆã‚’å—ã‘ãŸå¹½ç„ã®ä½“ç¾è€…ã€‚', skill:'å¹½ç„ã®æ¼”æŠ€ â€” æ­£è§£æ™‚ã«ç¾ã—ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç™ºå‹•ï¼' },
  { id:'kamakura_5', eraId:'kamakura', rarity:'N',  emoji:'ğŸ“¿', name:'å¾¡æˆæ•—å¼ç›®ã®æ›¸è¨˜',   desc:'æ³°æ™‚ã®å‘½ã§æ—¥æœ¬åˆã®æ­¦å®¶æ³•å…¸ã‚’æ›¸ãè¨˜ã—ãŸæ³•å¾‹å®¶ã€‚å…¬æ­£ãªè£ãã®ç²¾ç¥ã‚’å¾Œä¸–ã«ä¼ãˆãŸã€‚', skill:'æ³•ã®ç•ªäºº â€” å•é¡Œæ–‡ã®èª¤ã‚Šã‚’æŒ‡æ‘˜ã§ãã‚‹ï¼' },
  { id:'sengoku_1',  eraId:'sengoku',  rarity:'SR', emoji:'ğŸ”¥', name:'ç¹”ç”°ä¿¡é•·ã®é‰„ç ²éšŠé•·', desc:'é•·ç¯ ã®æˆ¦ã„ã§ä¸‰æ®µæ’ƒã¡ã‚’æŒ‡æ®ã—ãŸé©å‘½çš„è»äº‹å®¶ã€‚æ—§æ¥ã®é¨é¦¬æˆ¦æ³•ã‚’æ‰“ã¡ç ´ã£ãŸå¤©æ‰æˆ¦è¡“å®¶ã€‚', skill:'ä¸‰æ®µæ’ƒã¡ â€” é€£ç¶šæ­£è§£ã§æ”»æ’ƒåŠ›ãŒ3å€ã«ï¼' },
  { id:'sengoku_2',  eraId:'sengoku',  rarity:'R',  emoji:'ğŸŒº', name:'åƒåˆ©ä¼‘ã®èŒ¶äºº',       desc:'ã‚ã³ã®å¿ƒã‚’æ¥µã‚ãŸèŒ¶ã®æ¹¯ã®å¤§å®¶ã€‚ç§€å‰ã«ä»•ãˆãªãŒã‚‰ã‚‚ç¾æ„è­˜ã‚’è²«ãé€šã—ãŸèŠ¸è¡“å®¶ã€‚', skill:'ã‚ã³ã•ã³ã®å¿ƒ â€” å†·é™ã«è§£ã„ã¦æ­£ç­”ç‡ã‚¢ãƒƒãƒ—ï¼' },
  { id:'sengoku_3',  eraId:'sengoku',  rarity:'N',  emoji:'âš“', name:'å—è›®è²¿æ˜“å•†',         desc:'ãƒãƒ«ãƒˆã‚¬ãƒ«ã¨ã®äº¤æ˜“ã§å¯Œã‚’ç¯‰ã„ãŸå ºã®å•†äººã€‚é‰„ç ²ãƒ»ç«è–¬ãƒ»é¦™è¾›æ–™ã‚’æ—¥æœ¬ã«ã‚‚ãŸã‚‰ã—ãŸã€‚', skill:'è²¿æ˜“ã®çŸ¥è­˜ â€” å¤–æ¥èªå•é¡Œã«å¼·ããªã‚‹ï¼' },
  { id:'sengoku_4',  eraId:'sengoku',  rarity:'N',  emoji:'ğŸ—ºï¸', name:'å¤ªé–¤æ¤œåœ°ã®æ¸¬é‡å£«',   desc:'å…¨å›½ã‚’æ­©ãå›ã‚Šç”°ç•‘ã®çŸ³é«˜ã‚’æ¸¬å®šã—ãŸè±Šè‡£ã®å½¹äººã€‚ç§€å‰ã®å¤©ä¸‹çµ±ä¸€ã‚’æ•°å­—ã§æ”¯ãˆãŸã€‚', skill:'ç²¾å¯†æ¸¬é‡ â€” æ•°å­—ãƒ»å¹´å·å•é¡Œã®æ­£ç­”ç‡UPï¼' },
  { id:'sengoku_5',  eraId:'sengoku',  rarity:'N',  emoji:'ğŸ°', name:'å®‰åœŸåŸã®å»ºç¯‰å£«',     desc:'ä¿¡é•·ã®å¤¢ã‚’å½¢ã«ã—ãŸé©å‘½çš„ãªåŸéƒ­å»ºç¯‰å®¶ã€‚äº”é‡ã®å¤©ä¸»é–£ã¯å¤©ä¸‹å¸ƒæ­¦ã®è±¡å¾´ã ã£ãŸã€‚', skill:'å¤©å®ˆã®çœ¼ â€” å•é¡Œã®é›£æ˜“åº¦ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ï¼' },
  { id:'edo_1',      eraId:'edo',      rarity:'SR', emoji:'ğŸŒ¸', name:'æ¾å°¾èŠ­è•‰ã®å¼Ÿå­',     desc:'ä¿³è–èŠ­è•‰ã¨ã¨ã‚‚ã«å¥¥ã®ç´°é“ã‚’æ—…ã—ãŸä¿³äººã€‚è‡ªç„¶ã®ç¾ã‚’17æ–‡å­—ã«å°ã˜è¾¼ã‚ã‚‹é”äººã€‚', skill:'ä¿³å¥ã®åŠ› â€” å¿ƒãŒè½ã¡ç€ãæ­£ç­”ç‡10%UPï¼' },
  { id:'edo_2',      eraId:'edo',      rarity:'R',  emoji:'ğŸ—¾', name:'ä¼Šèƒ½å¿ æ•¬ã®åŠ©æ‰‹',     desc:'50æ­³ã‚’éããŸå¸«åŒ ã¨ã¨ã‚‚ã«å…¨å›½ã‚’æ¸¬é‡ã—ã¦æ­©ã„ãŸå¼Ÿå­ã€‚åŠªåŠ›ã¨ç²¾å¯†ã•ã‚’ä½“ç¾ã™ã‚‹äººç‰©ã€‚', skill:'ç²¾å¯†æ¸¬é‡è¡“ â€” ç­”ãˆã®é¸æŠè‚¢ãŒ1ã¤æ¶ˆãˆã‚‹ï¼' },
  { id:'edo_3',      eraId:'edo',      rarity:'N',  emoji:'ğŸ­', name:'æ­Œèˆä¼å½¹è€…',         desc:'æ±Ÿæˆ¸ã®åº¶æ°‘ã‚’é­…äº†ã—ãŸäººæ°—å½¹è€…ã€‚è’äº‹ãƒ»å’Œäº‹ã‚’æ¼”ã˜åˆ†ã‘ã€æ±Ÿæˆ¸æ–‡åŒ–ã®ä¸­å¿ƒã«ã„ãŸã€‚', skill:'ä¸ƒå¤‰åŒ– â€” å•é¡Œã®å½¢å¼ãŒå¤‰ã‚ã‚Šæ–°é®®ã«ãªã‚‹ï¼' },
  { id:'edo_4',      eraId:'edo',      rarity:'N',  emoji:'ğŸ“š', name:'æœ¬å±…å®£é•·ã®æ›¸ç”Ÿ',     desc:'å¤äº‹è¨˜ä¼ã‚’æ›¸ãè¨˜ã—ãŸå›½å­¦è€…ã®å¼Ÿå­ã€‚ã‚‚ã®ã®ã‚ã¯ã‚Œã®å¿ƒã§æ—¥æœ¬æ–‡åŒ–ã®æœ¬è³ªã‚’æ¢æ±‚ã—ãŸã€‚', skill:'å›½å­¦ã®çœ¼ â€” å¤å…¸å•é¡Œã«ç‰¹åŒ–ãƒœãƒ¼ãƒŠã‚¹ï¼' },
  { id:'edo_5',      eraId:'edo',      rarity:'N',  emoji:'ğŸ®', name:'å…ƒç¦„ã®ç“¦ç‰ˆå±‹',       desc:'å…ƒç¦„æ–‡åŒ–ã®æœ€æ–°æƒ…å ±ã‚’æ±Ÿæˆ¸ä¸­ã«ä¼ãˆãŸæƒ…å ±å±‹ã€‚æµ®ä¸–è‰å­ãƒ»äººå½¢æµ„ç‘ ç’ƒã®è©±é¡Œé€šã€‚', skill:'ç“¦ç‰ˆé€Ÿå ± â€” çŸ¥è­˜å•é¡Œã®ãƒ’ãƒ³ãƒˆãŒè‡ªå‹•è¡¨ç¤ºï¼' },
  { id:'meiji_1',    eraId:'meiji',    rarity:'SR', emoji:'ğŸš‚', name:'å²©å€‰ä½¿ç¯€å›£ã®æ›¸è¨˜å®˜', desc:'æ¬§ç±³12ãƒ¶å›½ã‚’è¦–å¯Ÿã—è¿‘ä»£åŒ–ã®çŸ¥è­˜ã‚’æŒã¡å¸°ã£ãŸæ˜æ²»ã®ä¿Šè‹±ã€‚æ—¥æœ¬ã®æ–‡æ˜é–‹åŒ–ã‚’è¨­è¨ˆã—ãŸã€‚', skill:'æ¬§ç±³ã®æ™º â€” è¿‘ä»£å²å•é¡Œã®æ­£ç­”ç‡2å€ï¼' },
  { id:'meiji_2',    eraId:'meiji',    rarity:'R',  emoji:'âš–ï¸', name:'è‡ªç”±æ°‘æ¨©ã®æ¼”èª¬è€…',   desc:'æ¿å£é€€åŠ©ã®æ€æƒ³ã‚’åœ°æ–¹ã«åºƒã‚ãŸæ”¿æ²»æ´»å‹•å®¶ã€‚æ°‘ä¸»ä¸»ç¾©ã®ç¨®ã‚’å…¨å›½ã«è’”ã„ãŸæƒ…ç†±ã®äººã€‚', skill:'æ°‘æ¨©æ¼”èª¬ â€” æ™‚é–“åˆ¶é™ãŒå»¶é•·ã•ã‚Œã‚‹ï¼' },
  { id:'meiji_3',    eraId:'meiji',    rarity:'N',  emoji:'ğŸ“°', name:'å¤§æ­£ãƒ‡ãƒ¢ã‚¯ãƒ©ã‚·ãƒ¼ã®è¨˜è€…', desc:'æ™®é€šé¸æŒ™ã‚’æ±‚ã‚ã¦ç­†ã‚’åŸ·ã‚Šç¶šã‘ãŸè¨˜è€…ã€‚å‰é‡ä½œé€ ã®æ°‘æœ¬ä¸»ç¾©ã‚’åºƒã‚ãŸè¨€è«–ã®å£«ã€‚', skill:'ãƒšãƒ³ã®åŠ› â€” æ–‡ç« é¡Œã®èª­è§£åŠ›ãŒUPï¼' },
  { id:'meiji_4',    eraId:'meiji',    rarity:'N',  emoji:'ğŸ­', name:'å¯Œå²¡è£½ç³¸å ´ã®å·¥å¥³',   desc:'ç¾¤é¦¬ã®å®˜å–¶å·¥å ´ã§è¿‘ä»£çš„ãªè£½ç³¸æŠ€è¡“ã‚’ç¿’å¾—ã—ãŸå°‘å¥³ã€‚æ—¥æœ¬ã®ç”£æ¥­é©å‘½ã‚’åº•ã§æ”¯ãˆãŸã€‚', skill:'å‹¤å‹‰ã®å¿ƒ â€” é€£ç¶šæ­£è§£æ™‚ã®å¾—ç‚¹ãŒå¢—åŠ ï¼' },
  { id:'meiji_5',    eraId:'meiji',    rarity:'N',  emoji:'âš“', name:'æ—¥éœ²æˆ¦äº‰ã®æ°´å…µ',     desc:'æ±éƒ·å¹³å…«éƒã®è‰¦éšŠã§ãƒãƒ«ãƒãƒƒã‚¯è‰¦éšŠã¨æˆ¦ã£ãŸè‹¥ãæ°´å…µã€‚æ—¥æœ¬æµ·æµ·æˆ¦ã®å¥‡è·¡ã‚’ç”Ÿãå»¶ã³ãŸã€‚', skill:'æµ·æˆ¦ã®å‹‡æ°— â€” ãƒ”ãƒ³ãƒã®æ™‚ã«é€†è»¢æ‰“ãŒå‡ºã‚„ã™ã„ï¼' },
  { id:'showa_1',    eraId:'showa',    rarity:'SR', emoji:'ğŸ•Šï¸', name:'æˆ¦å¾Œå¾©èˆˆã®å»ºç¯‰å£«',   desc:'ç„¼ã‘é‡åŸã‹ã‚‰æ—¥æœ¬ã‚’å†å»ºã—ãŸæŠ€è¡“è€…ã€‚1964å¹´æ±äº¬ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ã®ç«¶æŠ€å ´ã‚‚æ‰‹ãŒã‘ãŸã€‚', skill:'å¾©èˆˆã®åŠ› â€” èª¤ç­”å¾Œã«å€é€Ÿã§å›å¾©ã§ãã‚‹ï¼' },
  { id:'showa_2',    eraId:'showa',    rarity:'R',  emoji:'ğŸ’¹', name:'é«˜åº¦æˆé•·æœŸã®ç¤¾å“¡',   desc:'24æ™‚é–“åƒã„ãŸã‚µãƒ©ãƒªãƒ¼ãƒãƒ³ä¸–ä»£ã€‚æ—¥æœ¬ã‚’ä¸–ç•Œç¬¬2ä½ã®çµŒæ¸ˆå¤§å›½ã«æŠ¼ã—ä¸Šã’ãŸç¤ã€‚', skill:'çµŒæ¸ˆåŠ› â€” è§£ç­”ã™ã‚‹ã”ã¨ã«å¾—ç‚¹ãŒè¤‡åˆ©ã§å¢—ãˆã‚‹ï¼' },
  { id:'showa_3',    eraId:'showa',    rarity:'N',  emoji:'ğŸ“¡', name:'æ±äº¬äº”è¼ªã®è–ç«ãƒ©ãƒ³ãƒŠãƒ¼', desc:'1964å¹´ã®é–‹ä¼šå¼ã§è–ç«ã‚’é‹ã‚“ã åºƒå³¶ç”Ÿã¾ã‚Œã®é™¸ä¸Šé¸æ‰‹ã€‚å¹³å’Œã¨å¸Œæœ›ã‚’ä½“ç¾ã—ãŸèµ°è€…ã€‚', skill:'è–ç«ã®å…‰ â€” å…¨å•æ­£è§£æ™‚ã«ç‰¹åˆ¥ãƒœãƒ¼ãƒŠã‚¹ï¼' },
  { id:'showa_4',    eraId:'showa',    rarity:'N',  emoji:'ğŸŒº', name:'å®‰ä¿é—˜äº‰ã®å­¦ç”Ÿ',     desc:'1960å¹´ä»£ã«æ™‚ä»£ã¨æ ¼é—˜ã—ãŸå…¨å­¦é€£ã®æ´»å‹•å®¶ã€‚æ°‘ä¸»ä¸»ç¾©ã¸ã®ç†±ã„æƒ…ç†±ã‚’æŒã¡ç¶šã‘ãŸã€‚', skill:'æ™‚ä»£ã®é—˜å£« â€” ç¾ä»£å²å•é¡Œã®æ­£ç­”ç‡UPï¼' },
  { id:'showa_5',    eraId:'showa',    rarity:'N',  emoji:'ğŸŒ¸', name:'ãƒ’ãƒ­ã‚·ãƒã®ä¹™å¥³',     desc:'åºƒå³¶ãƒ»é•·å´ã¸ã®åŸçˆ†æŠ•ä¸‹ã‚’ç”Ÿãå»¶ã³ãŸäººã€…ã®ç·ç§°ã€‚å¹³å’Œã®å¤§åˆ‡ã•ã‚’èªã‚Šç¶™ãèªã‚Šéƒ¨ã¨ã—ã¦å¾Œä¸–ã«ä¼ãˆç¶šã‘ã¦ã„ã‚‹ã€‚', skill:'å¹³å’Œã®ç¥ˆã‚Š â€” æˆ¦é—˜ã‚’çµ‚ã‚ã‚‰ã›ã‚‹æœ€å¾Œã®åŠ›ï¼' },
];

const SECRET_CHARS = [
  { id:'secret_amaterasu', name:'å¤©ç…§å¤§ç¥',   emoji:'ğŸ‘‘', rarity:'SECRET', desc:'é«˜å¤©åŸã‚’çµ±ã¹ã‚‹å¤ªé™½ç¥ã€‚æ—¥æœ¬ã®ç¥è©±ã®æœ€é«˜ç¥ã§ã‚ã‚Šã€å¤©çš‡å®¶ã®ç¥–å…ˆç¥ã¨ã•ã‚Œã‚‹ã€‚å¤äº‹è¨˜ãƒ»æ—¥æœ¬æ›¸ç´€ã«è¨˜ã•ã‚ŒãŸç¥ã€…ã®é ‚ç‚¹ã€‚', skill:'ç¥è©±ã®åŠ› â€” ã™ã¹ã¦ã®å•é¡Œã®æ­£ç­”ç‡ãŒåŠ‡çš„ã«ã‚¢ãƒƒãƒ—ï¼' },
  { id:'secret_ryoma',     name:'é¾é¦¬ã®äº¡éœŠ', emoji:'ğŸ‰', rarity:'SECRET', desc:'æ—¥æœ¬ã®å¤œæ˜ã‘ã‚’å¤¢è¦‹ãŸå‚æœ¬é¾é¦¬ã®äº¡éœŠã€‚è–©é•·åŒç›Ÿãƒ»å¤§æ”¿å¥‰é‚„ã‚’é™°ã‹ã‚‰æ”¯ãˆãŸæ™‚ä»£ã®éµã€‚æš—æ®ºã•ã‚Œã¦ã‚‚ãªãŠæ—¥æœ¬ã®è¡Œãæœ«ã‚’è¦‹å®ˆã‚Šç¶šã‘ã‚‹ã€‚', skill:'èˆ¹ä¸­å…«ç­– â€” é–“é•ã£ãŸé¸æŠè‚¢ã‚’å…¨éƒ¨æ­£è§£ã«å¤‰ãˆã‚‹è’æ¥­ï¼' },
  { id:'secret_yamato',    name:'ãƒ¤ãƒãƒˆã‚¿ã‚±ãƒ«', emoji:'â›©', rarity:'SECRET', desc:'ç†Šè¥²ãƒ»è¦å¤·ã‚’å¾æœã—ãŸä¼èª¬ã®çš‡å­ã€‚è‰è–™ã®å‰£ã‚’æŒã¡ã€æ—¥æœ¬åˆ—å³¶çµ±ä¸€ã¸ã®é“ã‚’åˆ‡ã‚Šé–‹ã„ãŸã€‚å¤äº‹è¨˜æœ€å¤§ã®è‹±é›„ç¥è©±ã®ä¸»äººå…¬ã€‚', skill:'è‰è–™ã®å‰£ â€” æ•µã®å•é¡Œã‚’ã™ã¹ã¦è–™ãæ‰•ã†ä¸€æ’ƒå¿…æ®ºï¼' },
];

// STATE
let currentEra=null, currentDiff=null, currentQuestions=[], currentQIndex=0;
let score=0, correctCount=0, combo=0, timerInterval=null, timeLeft=20, answered=false;
let notionQuestions={};

// STORAGE
function loadProgress(){try{return JSON.parse(localStorage.getItem(LS.PROGRESS)||'{}')}catch{return{}}}
function saveProgress(p){localStorage.setItem(LS.PROGRESS,JSON.stringify(p))}
function loadUnlocked(){try{return new Set(JSON.parse(localStorage.getItem(LS.UNLOCKED)||'[]'))}catch{return new Set()}}
function saveUnlocked(s){localStorage.setItem(LS.UNLOCKED,JSON.stringify([...s]))}
function getNotionKey(){return localStorage.getItem(LS.NOTION_KEY)||''}
function getNotionCache(){try{return JSON.parse(localStorage.getItem(LS.NOTION_CACHE)||'null')}catch{return null}}
function setNotionCache(d){localStorage.setItem(LS.NOTION_CACHE,JSON.stringify(d))}

// NAVIGATION
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}
function showTitle(){showScreen('screen-title')}
function showEraSelect(){showScreen('screen-era');renderEraList()}
function showDiffSelect(){showScreen('screen-difficulty')}
function showZukan(){showScreen('screen-zukan');renderZukan()}
function showPassword(){
  showScreen('screen-password');
  const inp=document.getElementById('pwInput');inp.value='';inp.type='password';
  document.getElementById('pwError').textContent='';setTimeout(()=>inp.focus(),300);
}
function showAdmin(){showScreen('screen-admin');renderAdmin()}

// ERA LIST
function renderEraList(){
  const p=loadProgress();
  const cleared=ERAS.filter(e=>p[e.id]?.cleared).length;
  document.getElementById('eraProgress').textContent=`CHOOSE YOUR ERA â€” ${cleared}/8ã‚¯ãƒªã‚¢`;
  const tl=document.getElementById('eraTimeline'); tl.innerHTML='';
  ERAS.forEach(era=>{
    const ep=p[era.id]||{};
    const item=document.createElement('div');
    item.className='era-item'+(ep.cleared?' cleared':'');
    item.innerHTML=`
      <div class="era-dot" style="border-color:${era.color};background:rgba(${hexRgb(era.color)},.15);box-shadow:0 0 12px ${era.glow}"><span>${era.emoji}</span></div>
      <div class="era-card-inner">
        <div class="era-card-name">${era.name}</div>
        <div class="era-card-period">${era.period}</div>
        <div class="era-card-meta">
          <div style="font-size:16px">${ep.cleared?'âœ…':''}</div>
          <div class="era-card-count">${ep.playCount?ep.playCount+'å›':'æœªãƒ—ãƒ¬ã‚¤'}</div>
        </div>
        <div class="era-card-bar" style="background:${era.color};width:${ep.cleared?100:0}%"></div>
      </div>`;
    item.addEventListener('click',()=>selectEra(era));
    tl.appendChild(item);
  });
}
function hexRgb(h){const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return`${r},${g},${b}`}

function selectEra(era){
  currentEra=era;
  document.getElementById('diffEraTitle').textContent=era.emoji+' '+era.name;
  showDiffSelect();
}

// QUESTIONS
function getQuestions(era,diff){
  const cached=notionQuestions[era.notionName]||[];
  if(!cached.length) return getFallback(era,diff);
  let pool=diff==='all'?cached:cached.filter(q=>q.difficulty===DIFF_LABELS[diff]);
  if(!pool.length) return getFallback(era,diff);
  return shuffle([...pool]).slice(0,diff==='all'?15:5);
}
function getFallback(era,diff){
  return[{question:`ã€${era.name}ã€‘Notionã‹ã‚‰å•é¡ŒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ç®¡ç†ç”»é¢ã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚`,choices:['è¨­å®šæ–¹æ³•ã¯READMEã‚’å‚ç…§','ç®¡ç†ç”»é¢ã‹ã‚‰APIã‚­ãƒ¼å…¥åŠ›','Notionã«å•é¡Œã‚’è¿½åŠ ','ã“ã®é¸æŠè‚¢ã¯ãƒ€ãƒŸãƒ¼'],answer:1,hint:'ç®¡ç†ç”»é¢ â†’ Notion APIé€£æº â†’ APIã‚­ãƒ¼ã‚’ä¿å­˜ â†’ æ‰‹å‹•åŒæœŸ'}];
}

// QUIZ
function startQuiz(diff){
  currentDiff=diff; currentQuestions=getQuestions(currentEra,diff);
  currentQIndex=0; score=0; correctCount=0; combo=0;
  document.getElementById('quizEraLabel').textContent=currentEra.name;
  document.getElementById('quizCharEmoji').textContent=currentEra.charEmoji;
  document.getElementById('quizCharName').textContent=currentEra.char;
  showScreen('screen-quiz'); renderQuestion();
}
function renderQuestion(){
  clearTimer(); answered=false;
  document.getElementById('hintBubble').classList.remove('visible');
  document.getElementById('nextQBtn').style.display='none';
  const q=currentQuestions[currentQIndex];
  document.getElementById('qNumber').textContent=`å•${currentQIndex+1} / ${currentQuestions.length}`;
  document.getElementById('qText').textContent=q.question;
  document.getElementById('scoreDisplay').textContent=score;
  const area=document.getElementById('choicesArea'); area.innerHTML='';
  ['ï¼¡','ï¼¢','ï¼£','ï¼¤'].forEach((lbl,i)=>{
    const btn=document.createElement('button'); btn.className='choice-btn';
    btn.innerHTML=`<span class="choice-label">${lbl}</span>${q.choices[i]}`;
    btn.addEventListener('click',()=>selectAnswer(i)); area.appendChild(btn);
  });
  startTimer();
}
function startTimer(){
  timeLeft=20; updateTimerUI();
  timerInterval=setInterval(()=>{timeLeft--;updateTimerUI();if(timeLeft<=0){clearTimer();if(!answered)timeUp();}},1000);
}
function updateTimerUI(){
  const pct=(timeLeft/20)*100, bar=document.getElementById('timerBar');
  bar.style.width=pct+'%';
  bar.style.background=pct<30?'var(--red)':pct<60?'linear-gradient(90deg,#ff8800,var(--accent))':'linear-gradient(90deg,var(--gold),var(--accent))';
  document.getElementById('timerText').textContent=timeLeft+'ç§’';
}
function clearTimer(){if(timerInterval){clearInterval(timerInterval);timerInterval=null;}}
function timeUp(){
  answered=true; combo=0;
  const q=currentQuestions[currentQIndex];
  document.querySelectorAll('.choice-btn').forEach((b,i)=>{b.classList.add('disabled');if(i===q.answer)b.classList.add('correct');});
  document.getElementById('nextQBtn').style.display='block';
}
function selectAnswer(sel){
  if(answered)return; answered=true; clearTimer();
  const q=currentQuestions[currentQIndex];
  const btns=document.querySelectorAll('.choice-btn'); btns.forEach(b=>b.classList.add('disabled'));
  if(sel===q.answer){
    btns[sel].classList.add('correct'); correctCount++; combo++;
    score+=100+(timeLeft*5)+(combo>1?combo*20:0);
    spawnParticles(btns[sel]); if(combo>=2)showCombo(combo);
  } else {
    btns[sel].classList.add('wrong'); btns[q.answer].classList.add('correct'); combo=0;
    if(q.hint){document.getElementById('hintText').textContent=q.hint;document.getElementById('hintBubble').classList.add('visible');}
  }
  document.getElementById('scoreDisplay').textContent=score;
  document.getElementById('nextQBtn').style.display='block';
}
function nextQuestion(){currentQIndex++;if(currentQIndex>=currentQuestions.length)showResult();else renderQuestion();}

// RESULT
function showResult(){
  showScreen('screen-result');
  const total=currentQuestions.length, pct=correctCount/total;
  let rank,title;
  if(pct===1){rank='ğŸ†';title='å¤©ã€€ä¸‹ã€€äºº';}
  else if(pct>=.8){rank='â­â­';title='æ­´å²ã®ä½¿ã„æ‰‹';}
  else if(pct>=.6){rank='â­';title='æ­´å²ã®è¦‹ç¿’ã„';}
  else if(pct>=.4){rank='ğŸ“š';title='ã¾ã ã¾ã ä¿®è¡Œä¸­';}
  else{rank='ğŸ’€';title='æ•—è€…å¾©æ´»ã‚’ç‹™ãˆï¼';}
  document.getElementById('resultRank').textContent=rank;
  document.getElementById('resultTitle').textContent=title;
  document.getElementById('resultScore').textContent=score;
  document.getElementById('resultCorrect').textContent=`${total}å•ä¸­ ${correctCount}å•æ­£è§£`;
  // save progress
  const p=loadProgress(); if(!p[currentEra.id])p[currentEra.id]={};
  const ep=p[currentEra.id];
  ep.playCount=(ep.playCount||0)+1; ep.bestScore=Math.max(ep.bestScore||0,score);
  if(pct===1){if(currentDiff==='all')ep.cleared=true;else{ep[`cleared_${currentDiff}`]=true;if(ep.cleared_easy&&ep.cleared_normal&&ep.cleared_hard)ep.cleared=true;}}
  saveProgress(p);
  // gacha
  const char=drawCharacter(pct);
  if(char)showGacha(char);else document.getElementById('resultGacha').classList.remove('visible');
}
function drawCharacter(pct){
  if(pct<.4)return null;
  const p=loadProgress();
  const allCleared=ERAS.every(e=>p[e.id]?.cleared);
  const isPerfect=correctCount===currentQuestions.length;
  if(allCleared&&isPerfect&&Math.random()<.05){
    const u=loadUnlocked(),locked=SECRET_CHARS.filter(c=>!u.has(c.id));
    if(locked.length){const char=locked[Math.floor(Math.random()*locked.length)];u.add(char.id);saveUnlocked(u);return{...char,isNew:true};}
  }
  const eraChars=ALL_CHARS.filter(c=>c.eraId===currentEra.id);
  const weights=eraChars.map(c=>c.rarity==='SR'?10:c.rarity==='R'?30:60);
  const totalW=weights.reduce((a,b)=>a+b,0); let r=Math.random()*totalW;
  let chosen=eraChars[eraChars.length-1];
  for(let i=0;i<eraChars.length;i++){r-=weights[i];if(r<=0){chosen=eraChars[i];break;}}
  const u=loadUnlocked(),isNew=!u.has(chosen.id);
  u.add(chosen.id);saveUnlocked(u);return{...chosen,isNew};
}
function showGacha(char){
  document.getElementById('resultGacha').classList.add('visible');
  document.getElementById('gachaEmoji').textContent=char.emoji;
  const rb=document.getElementById('gachaRarity'); rb.textContent=char.rarity; rb.className=`gacha-rarity-badge ${char.rarity}`;
  document.getElementById('gachaNewBadge').style.display=char.isNew?'inline-block':'none';
  document.getElementById('gachaName').textContent=char.name;
  document.getElementById('gachaDesc').textContent=char.desc;
  document.getElementById('gachaSkill').textContent=char.skill;
}
function replayQuiz(){startQuiz(currentDiff);}

// ZUKAN
function renderZukan(){
  const u=loadUnlocked(),p=loadProgress();
  const total=ALL_CHARS.length+SECRET_CHARS.length;
  document.getElementById('zukanProgress').textContent=`${u.size} / ${total} ä½“ç²å¾—`;
  let html='';
  ERAS.forEach(era=>{
    const eraChars=ALL_CHARS.filter(c=>c.eraId===era.id);
    const uc=eraChars.filter(c=>u.has(c.id)).length;
    html+=`<div class="zukan-era-section"><div class="zukan-era-header"><span class="zukan-era-emoji">${era.emoji}</span><span class="zukan-era-name">${era.name}</span><span class="zukan-era-count">${uc}/${eraChars.length}</span></div><div class="zukan-chars-grid">`;
    eraChars.forEach(c=>{
      const ul=u.has(c.id);
      html+=`<div class="zukan-char-card ${ul?'unlocked '+c.rarity:'locked'}" ${ul?`onclick="showCharModal('${c.id}','normal')"`:''}>${ul?c.emoji:'â”'}<div class="zukan-char-rarity ${ul?c.rarity:''}">${ul?c.rarity:''}</div><div class="zukan-char-label">${ul?c.name:'?'}</div></div>`;
    });
    html+='</div></div>';
  });
  // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¬„ã¯æœ€å¾Œ
  const allCleared=ERAS.every(e=>p[e.id]?.cleared);
  html+='<div class="zukan-secret-section"><div class="zukan-secret-title">âœ¨ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</div>';
  html+='<div class="zukan-secret-chars">';
  SECRET_CHARS.forEach(c=>{
    const ul=u.has(c.id);
    html+=`<div class="secret-char-card ${ul?'unlocked':'locked-secret'}" ${ul?`onclick="showCharModal('${c.id}','secret')"`:''}><div class="secret-emoji">${ul?c.emoji:'â“'}</div><div class="secret-name">${ul?c.name:'???'}</div><div class="secret-hint">${ul?'ç²å¾—æ¸ˆã¿ âœ“':'ç‰¹å®šã®æ¡ä»¶ã‚’æº€ãŸã™ã¨å‡ºç¾'}</div></div>`;
  });
  html+='</div></div>';
  document.getElementById('zukanBody').innerHTML=html;
}
function showCharModal(id,type){
  const char=type==='secret'?SECRET_CHARS.find(c=>c.id===id):ALL_CHARS.find(c=>c.id===id);
  if(!char)return;
  document.getElementById('modalEmoji').textContent=char.emoji;
  const rb=document.getElementById('modalRarity'); rb.textContent=char.rarity; rb.className=`modal-rarity ${char.rarity}`;
  document.getElementById('modalName').textContent=char.name;
  document.getElementById('modalDesc').textContent=char.desc;
  document.getElementById('modalSkill').textContent=char.skill;
  document.getElementById('charModal').classList.add('active');
}
function closeCharModal(){document.getElementById('charModal').classList.remove('active');}

// PASSWORD / ADMIN
function togglePwVisibility(){
  const inp=document.getElementById('pwInput'),btn=document.getElementById('pwToggle');
  inp.type=inp.type==='password'?'text':'password'; btn.textContent=inp.type==='password'?'ğŸ‘':'ğŸ™ˆ';
}
function checkPassword(){
  const val=document.getElementById('pwInput').value, inp=document.getElementById('pwInput');
  if(val===ADMIN_PASSWORD){showAdmin();}
  else{inp.classList.remove('error');void inp.offsetWidth;inp.classList.add('error');document.getElementById('pwError').textContent='ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';inp.value='';setTimeout(()=>inp.classList.remove('error'),500);}
}
function renderAdmin(){
  const p=loadProgress(),u=loadUnlocked();
  const cleared=ERAS.filter(e=>p[e.id]?.cleared).length;
  const cache=getNotionCache(),cc=cache?Object.values(cache).reduce((a,e)=>a+e.length,0):0;
  document.getElementById('adminStats').innerHTML=`
    <div class="admin-stat-card"><div class="admin-stat-num">${cleared}</div><div class="admin-stat-label">æ™‚ä»£ã‚¯ãƒªã‚¢</div></div>
    <div class="admin-stat-card"><div class="admin-stat-num">${u.size}</div><div class="admin-stat-label">ã‚­ãƒ£ãƒ©ç²å¾—</div></div>
    <div class="admin-stat-card"><div class="admin-stat-num">${cc}</div><div class="admin-stat-label">ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œ</div></div>
    <div class="admin-stat-card"><div class="admin-stat-num">${getNotionKey()?'âœ“':'Ã—'}</div><div class="admin-stat-label">NotionAPI</div></div>
  `;
  const key=getNotionKey(); if(key)document.getElementById('notionApiInput').value=key;
}
function saveNotionKey(){
  const key=document.getElementById('notionApiInput').value.trim();
  if(!key.startsWith('secret_')){adminLog('âŒ APIã‚­ãƒ¼ã¯ secret_ ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');return;}
  localStorage.setItem(LS.NOTION_KEY,key); adminLog('âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
async function syncFromNotion(){
  const key=getNotionKey(); if(!key){adminLog('âŒ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');return;}
  adminLog('ğŸ”„ Notionã‹ã‚‰åŒæœŸä¸­...'); showLoading('NotionåŒæœŸä¸­...');
  try{
    const data=await fetchAllNotionQuestions(key); setNotionCache(data); notionQuestions=data;
    const total=Object.values(data).reduce((a,e)=>a+e.length,0);
    adminLog(`âœ… åŒæœŸå®Œäº†ï¼ ${total}å•ã‚’å–å¾—`); renderAdmin();
  }catch(e){adminLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`);}
  finally{hideLoading();}
}
async function fetchAllNotionQuestions(apiKey){
  const result={}; let hasMore=true,cursor;
  while(hasMore){
    const body={filter:{property:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',select:{equals:'å®Œæˆ'}},page_size:100};
    if(cursor)body.start_cursor=cursor;
    const res=await fetch(`https://api.notion.com/v1/databases/${NOTION_DB_ID}/query`,{method:'POST',headers:{'Authorization':`Bearer ${apiKey}`,'Notion-Version':'2022-06-28','Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    const json=await res.json();
    json.results.forEach(page=>{
      const pr=page.properties,era=pr['æ™‚ä»£']?.select?.name; if(!era)return;
      const q=pr['å•é¡Œæ–‡']?.title?.[0]?.plain_text||'';
      const ca=pr['é¸æŠè‚¢A']?.rich_text?.[0]?.plain_text||'',cb=pr['é¸æŠè‚¢B']?.rich_text?.[0]?.plain_text||'',cc2=pr['é¸æŠè‚¢C']?.rich_text?.[0]?.plain_text||'',cd=pr['é¸æŠè‚¢D']?.rich_text?.[0]?.plain_text||'';
      const ans=pr['æ­£è§£']?.select?.name||'A',hint=pr['ãƒ’ãƒ³ãƒˆæ–‡']?.rich_text?.[0]?.plain_text||'',diff=pr['é›£æ˜“åº¦']?.select?.name||'';
      if(!result[era])result[era]=[];
      result[era].push({question:q,choices:[ca,cb,cc2,cd],answer:{A:0,B:1,C:2,D:3}[ans]??0,hint,difficulty:diff});
    });
    hasMore=json.has_more; cursor=json.next_cursor;
  }
  return result;
}
function adminLog(msg){const el=document.getElementById('adminLog');el.textContent+=msg+'\n';el.scrollTop=el.scrollHeight;}
function confirmReset(type){
  const labels={progress:'é€²è¡ŒçŠ¶æ³',chars:'ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿',all:'å…¨ãƒ‡ãƒ¼ã‚¿'};
  if(!confirm(`${labels[type]}ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`))return;
  if(type==='progress'||type==='all')localStorage.removeItem(LS.PROGRESS);
  if(type==='chars'||type==='all')localStorage.removeItem(LS.UNLOCKED);
  if(type==='all'){localStorage.removeItem(LS.NOTION_KEY);localStorage.removeItem(LS.NOTION_CACHE);notionQuestions={};}
  adminLog(`âœ… ${labels[type]}ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`); renderAdmin(); showToast(`${labels[type]}ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`);
}

// COMBO / PARTICLES
function showCombo(n){
  const el=document.getElementById('comboFlash');
  el.textContent={2:'COMBO!',3:'GREAT!!',4:'AMAZING!!!',5:'PERFECT!!!!'}[n]||`${n}é€£ç¶šï¼`;
  el.style.color={2:'#ffcc00',3:'#ff8800',4:'#ff4422',5:'#ff00ff'}[n]||'#ff00ff';
  el.classList.remove('show'); void el.offsetWidth; el.classList.add('show');
}
function spawnParticles(el){
  const rect=el.getBoundingClientRect(),cx=rect.left+rect.width/2,cy=rect.top+rect.height/2;
  for(let i=0;i<12;i++){
    const p=document.createElement('div'); p.className='particle';
    const angle=(i/12)*360,dist=60+Math.random()*60;
    p.style.cssText=`left:${cx}px;top:${cy}px;background:${['#ffcc00','#ff4422','#00c864'][i%3]};--tx:${Math.cos(angle*Math.PI/180)*dist}px;--ty:${Math.sin(angle*Math.PI/180)*dist}px;`;
    document.body.appendChild(p); setTimeout(()=>p.remove(),1000);
  }
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
let toastTimer=null;
function showToast(msg,err=false){
  const el=document.getElementById('toast'); el.textContent=msg; el.classList.toggle('error-toast',err); el.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer); toastTimer=setTimeout(()=>el.classList.remove('show'),2500);
}
function showLoading(t='èª­ã¿è¾¼ã¿ä¸­â€¦'){document.getElementById('loadingText').textContent=t;document.getElementById('loadingOverlay').classList.add('visible');}
function hideLoading(){document.getElementById('loadingOverlay').classList.remove('visible');}

// BOOT
(async function(){
  const cache=getNotionCache();
  if(cache){notionQuestions=cache;const t=Object.values(cache).reduce((a,e)=>a+e.length,0);if(t>0)showToast(`ğŸ“š ${t}å•ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);}
  renderEraList();
  const key=getNotionKey();
  if(key)(async()=>{try{const d=await fetchAllNotionQuestions(key);setNotionCache(d);notionQuestions=d;const t=Object.values(d).reduce((a,e)=>a+e.length,0);if(t>0)showToast(`âœ… NotionåŒæœŸå®Œäº† (${t}å•)`);}catch(e){console.warn('sync fail:',e.message);}})();
  if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js').catch(()=>{});
})();
</script>
</body>
</html>
